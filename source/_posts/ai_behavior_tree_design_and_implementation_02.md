# AI 行为树设计与实现-实践篇

上一篇文章中，我们主要介绍了有限状态机和行为树的各自特点以及他们之间的优劣势，本文着重讲解如何实现一个可用的行为树，手动实现一个行为树的库，这个库代码不到200行，采用的语言是 Lua，当然你也可以翻译成其他任何你顺手的语言，最后我们将通过我们实现的库代码，实现一个上文讲到的 NPC 守夜巡逻的 AI 例子。

对于一个行为树系统，其核心部分主要是其提供的控制节点，通过控制节点，我们可根据自己的游戏需求拓展出一套相对应的条件与行为节点。

## 控制节点实现

上一节我们提到，控制节点是行为树的核心部分，它与具体的游戏逻辑是无关的，它只负责整个行为树的逻辑控制。

### 组合节点(Coposite)

组合节点可以看作是一个节点的集合，可以组合多个子节点。

### 装饰节点(Decoraor)

装饰节点可以作为某种节点的一种额外的附加条件，如允许次数限制，时间限制，错误处理等。

## 行为节点实现

对于一个树形结构，最开始我们应该抽象出一个节点的基类出来，节点基类只有一个成员，那就是“黑板”，黑板中包含了整个行为树可以操作的数据结构，如 NPC 对象、玩家对象等等。具体可以参考维基百科关于“黑板模式”的解答。

任何节点执行后都是会产生一个状态的，如果它执行尚未完成，则返回给父节点正在运行，如果节点已经达到其目标，则返回执行成功，否则返回失败。